<html>
	<head>
		<script src="bower_components/jquery/jquery.js" type="text/javascript"></script>
		<link rel="stylesheet" href="bower_components/drawingboard.js/dist/drawingboard.min.css">
		<link rel="stylesheet" href="style.css">
		<script src="bower_components/drawingboard.js/dist/drawingboard.min.js" type="text/javascript"></script>
		<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.3/firebase.js'></script>
	</head>

	<body>
		<script>

			var myRootRef = new Firebase('https://amber-fire-337.firebaseio.com/');
			var roomsRef = new Firebase('https://amber-fire-337.firebaseio.com/Rooms/');
			var room1Ref = new Firebase('https://amber-fire-337.firebaseio.com/Rooms/room1');
			var room2Ref = new Firebase('https://amber-fire-337.firebaseio.com/Rooms/room2');
			var room3Ref = new Firebase('https://amber-fire-337.firebaseio.com/Rooms/room3');

			var myRoom;
			var inRoom = false;
			var k;
	  	    allRooms = {room1Ref: room1Ref, room2Ref: room2Ref, room3Ref: room3Ref};
	  	    for(var i in allRooms) 
	  	    {
	  	      console.log(allRooms[i]);
	  	  	  allRooms[i].once('value',  
	  	  	  	(function(a) { 
	  	  	  		return function(snapshot) {
	  	  		  	  if(snapshot.val().playerCount<6 && inRoom === false && snapshot.val().started === 0) 
	  	  		  	  {
	  	  			  	myRoom = a;
	  	  			  	inRoom = true;
		  	  			console.log("entered a room");
	  	  			  	var numPlayers = snapshot.child("playerCount").val();
	  	  			  	allRooms[a].child("playerCount").set(parseInt(numPlayers)+1);
	  	  		  	  }
	  	  		  	}
	  	  		})(i) 
	  	  	   );
	  	  	}
	  	    
			$('body').append("<div id=drawCanvas></div>");
			var newBoard = new DrawingBoard.Board('drawCanvas', {
				controls: [
					'Color',
					{ Size: { type: 'dropdown' } },
					{ DrawingMode: { filler: true } },
					'Navigation',
					'Download'
				],
				size: 1,
				webStorage: 'session',
				enlargeYourContainer: true
			});
			$('body').append("<button onclick=getImageUrl()>Submit!</button>");
			
			//save canvas image in url
			var getImageUrl = function(){

				var foobs = newBoard.canvas.toDataURL('image/png');
				// console.log(myRoom);
				allRooms[myRoom].once('value', function(snapshot){
					var currentDocs = snapshot.child("playerDocs").val();
					var numPlayers = snapshot.child("playerCount").val();
					var subCount = snapshot.child("Submissions").val();
					var hasStarted = snapshot.child("started").val();
					allRooms[myRoom].child("docs").push(foobs);					
					allRooms[myRoom].child("Submissions").set(parseInt(subCount)+1);
					console.log(subCount);					
					console.log(allRooms[myRoom].child("docs"));
					// console.log(snapshot.child("docs").val);
					// currentDocs.pieces.push([foobs]);	
					// console.log(currentDocs);		
					// allRooms[myRoom].child("playerDocs").set(currentDocs);
					if(hasStarted===0){
						allRooms[myRoom].child("started").set(1);
					}
				});
				// console.log(foobs);
				return foobs;
			};

		</script>
	</body>
</html>